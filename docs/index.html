<!DOCTYPE html>
<html>
<head>
  <title>Vue SPA Example</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://unpkg.com/vue-router@4"></script>
</head> 
<body>
  <div id="app">
    <router-view></router-view>
  </div>

  <script>
    function getDoubleMatches(arr) {
      const result = [];
      const seenPlayers = new Set();

      // Shuffle the array to ensure randomness
      arr = arr.sort(() => Math.random() - 0.5);

      for (let i = 0; i < arr.length; i++) {
        for (let j = i + 1; j < arr.length; j++) {
          for (let k = 0; k < arr.length; k++) {
            if (k === i || k === j || seenPlayers.has(arr[i]) || seenPlayers.has(arr[j])) continue;
            for (let l = k + 1; l < arr.length; l++) {
              if (l === i || l === j || seenPlayers.has(arr[k]) || seenPlayers.has(arr[l])) continue;
              result.push([[arr[i], arr[j]], [arr[k], arr[l]]]);
              seenPlayers.add(arr[i]);
              seenPlayers.add(arr[j]);
              seenPlayers.add(arr[k]);
              seenPlayers.add(arr[l]);
              // After a match, reset the seenPlayers set
              seenPlayers.clear();
            }
          }
        }
      }
      return result;
    }

    function shuffleArray(array) {
      let currentIndex = array.length, randomIndex;

      while (currentIndex != 0) {
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;
        [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
      }

      return array;
    } 

    const PageA = {
      template: `
        <div>
          <h3>名前を選択してください。</h3>
          <ul>
          <table>
            <thead>
              <tr>
                <th>名前</th>
                <th>選択</th>
              </tr>
            </thead>
          <tbody>
            <tr v-for="name in names" :key="name">
              <td><label :for="name">{{ name }}</label></td>
              <td>
                <input type="checkbox" :id="name" v-model="selectedNames" :value="name">
              </td>
            </tr>
          </tbody>
        </table>
        </ul>
        <br>
        <div v-if="selectedNames.length < 4" style="color: red;">少なくとも4つの名前を選択してください。</div>
        <div v-else>
          <router-link to="/pageb">ダブルス組み合わせへ</router-link>
        </div>
      `,
      data() {
        return {
          names: ['田中', '佐藤', '鈴木', '高橋', '伊藤', '渡辺', '山本'],
          selectedNames: []
        };
      },
      watch: {
        selectedNames: {
          handler(newVal) {
            localStorage.setItem('selectedNames', JSON.stringify(newVal));
          },
          deep: true
        }
      },
      mounted() {
        const storedNames = localStorage.getItem('selectedNames');
        if (storedNames) {
          this.selectedNames = JSON.parse(storedNames);
        }
      }
    };

    const PageB = {
      template: `
        <div>
          <h3>試合順</h3>
          <ul>
            <table>
              <thead>
                <tr>
                  <th>番号</th>
                  <th>名前 1</th>
                  <th>名前 2</th>
                  <th>名前 3</th>
                  <th>名前 4</th>
                </tr>
              </thead>
          <tbody>
            <tr v-for="(match, matchIndex ) in matches" :key="matchIndex">
              <td align="center">{{ matchIndex + 1 }}</td>
              <td v-for="i in match" :key="i" align="center">
                {{ gameNames[i - 1]}}{{i}}
              </td>
            </tr>
          </tbody>
        </table>
        </ul>
          <br>
          <router-link to="/">メンバー選択へ</router-link>
        </div>
      `,
      data() {
        return {
          selectedNames: [],
          gameNames: [],
          matches: [],
          combination_data : [
            {'num': 4, 'list': [[1,2,3,4], [1,3,2,4], [1,4,2,3]]},
            {'num': 5, 'list': [[1,2,3,4], [1,5,2,3], [1,4,2,5], [1,3,4,5], [2,4,3,5], [1,3,2,4], [3,5,1,2], [4,5,1,2], [3,4,1,5], [2,3,4,5], [1,4,2,3], [2,5,1,3], [2,4,1,5], [3,5,1,4], [2,5,3,4]]},
            {'num': 6, 'list': [[1,2,3,4], [5,6,1,3], [2,5,4,6], [1,6,2,3], [2,4,1,5], [3,6,4,5], [1,4,2,6], [3,5,1,2], [3,4,5,6], [1,3,2,5], [2,4,1,6], [3,5,4,6], [1,5,2,6], [2,3,4,5], [1,4,3,6]]},
            {'num': 7, 'list': [[1,2,3,4], [5,6,1,7], [2,3,5,7], [1,4,2,6], [3,7,4,6], [2,5,1,3], [4,5,6,7], [1,6,2,7], [3,5,2,4], [1,5,3,6], [4,7,1,2], [3,5,4,6], [2,7,3,6], [1,4,5,7], [2,6,4,5]]},
            {'num': 8, 'list': [[1,2,3,4], [5,6,7,8], [1,3,5,7], [2,4,6,8], [1,5,4,8], [2,3,6,7], [1,6,4,7], [2,5,3,8], [1,7,2,8], [3,5,4,6], [1,8,3,6], [2,7,4,5], [1,4,3,7], [2,6,5,8], [1,2,5,6]]}
          ],
        };
      },
      mounted() {
        const storedNames = localStorage.getItem('selectedNames');
        if (storedNames) {
          this.selectedNames = JSON.parse(storedNames);
          const arrNames = Object.values(this.selectedNames);
          console.log(arrNames)
          const shuffleNames = shuffleArray(arrNames)
          console.log(shuffleNames)
          console.log(shuffleNames.length)
          console.log(this.combination_data[0].num);
          this.gameNames = shuffleNames;
          this.matches = this.combination_data[shuffleNames.length-4].list;
          // 名前をシャッフルして番号をつける
          // 番号とつけたら、その順番に表示する
        }

        /*
        const storedNames = localStorage.getItem('selectedNames');
        if (storedNames) {
          this.selectedNames = JSON.parse(storedNames);
          if (this.selectedNames.length >= 4) {
            this.matches = getDoubleMatches(this.selectedNames);
          }
        }
        */
      }
    };

    const routes = [
      { path: '/', component: PageA },
      { path: '/pageb', component: PageB },
    ];

    const router = VueRouter.createRouter({
      history: VueRouter.createWebHashHistory(),
      routes,
    });

    const app = Vue.createApp({});
    app.use(router);
    app.mount('#app');
  </script>
</body>
</html>
